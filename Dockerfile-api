FROM adoptopenjdk:14-jdk-hotspot AS builder

# Leiningen
ADD https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein /usr/local/bin/lein
RUN chmod 755 /usr/local/bin/lein

# avoid tzdata installation starting to ask questions
ARG DEBIAN_FRONTEND=noninteractive

# PostgreSQL
RUN apt-get update && \
    apt-get install -y gnupg && \
    echo 'deb http://apt.postgresql.org/pub/repos/apt/ bionic-pgdg main' > /etc/apt/sources.list.d/pgdg.list  && \
    curl --silent https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - && \
    apt-get update && \
    apt-get install -y postgresql-11 postgresql-11-postgis-3 sudo

# working directory
RUN mkdir -p /project
WORKDIR /project

# cache Leiningen dependencies
COPY project.clj /project/
RUN lein deps

# source code
COPY resources /project/resources
COPY test /project/test
COPY src /project/src
COPY src-java /project/src-java

# run tests
COPY test-config.edn /project/
RUN service postgresql start && \
    sudo -u postgres psql -c "CREATE USER territorybro WITH CREATEROLE PASSWORD 'territorybro';" && \
    sudo -u postgres psql -c "CREATE DATABASE territorybro OWNER territorybro;" && \
    sudo -u postgres psql -d territorybro -c "CREATE EXTENSION postgis;" && \
    # XXX since the territorybro user is not SUPERUSER, the REVOKE in resources/db/flyway/master/R__permissions.sql does nothing
    sudo -u postgres psql -d territorybro -c "REVOKE CREATE ON SCHEMA public FROM PUBLIC;" && \
    lein kaocha && \
    service postgresql stop

# build the binary
RUN lein uberjar

# ------------------------------------------------------------

FROM adoptopenjdk:14-jre-hotspot

RUN adduser --system --home /app app
WORKDIR /app
USER app

EXPOSE 8080
ENV PORT=8080 \
    NREPL_BIND=0.0.0.0 \
    DATABASE_URL="jdbc:postgresql://localhost/territorybro?user=territorybro&password=territorybro"
ENTRYPOINT ["java", "--illegal-access=deny", "-jar", "territory-bro.jar"]

COPY --from=builder /project/target/uberjar/territory-bro.jar /app/territory-bro.jar
